<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LexiMagic - Versão Final</title>
    <style>
        /* --- ESTILOS (CSS) --- */
        :root {
            --bg-dark: #121212;
            --sidebar-bg: #1e1e1e;
            --card-bg: #2d2d2d;
            --accent: #bb86fc;
            --text-main: #ffffff;
            --text-dim: #b0b0b0;
            --success: #03dac6;
            --error: #cf6679;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        .app-container { display: flex; width: 100%; height: 100%; }

        /* BARRA LATERAL */
        .sidebar {
            width: 300px;
            background: var(--sidebar-bg);
            padding: 20px;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        .sidebar h2 { color: var(--accent); margin: 0; font-size: 1.8rem; }
        .sidebar h3 { font-size: 0.8rem; text-transform: uppercase; color: var(--text-dim); letter-spacing: 1px; }

        .rule-card {
            background: var(--card-bg);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #444;
            opacity: 0.5;
            transition: 0.3s;
        }

        .rule-active {
            opacity: 1;
            border-left-color: var(--accent);
            background: #383838;
            transform: translateX(5px);
        }

        .history-section { flex-grow: 1; display: flex; flex-direction: column; min-height: 150px; }
        .history-list {
            background: #000;
            border-radius: 6px;
            padding: 10px;
            flex-grow: 1;
            overflow-y: auto;
            font-family: monospace;
            color: var(--accent);
            border: 1px solid #333;
        }

        #clear-history {
            background: transparent;
            border: 1px solid var(--error);
            color: var(--error);
            margin-top: 10px;
            padding: 5px;
            border-radius: 4px;
            cursor: pointer;
        }

        .status-info { margin-top: auto; padding-top: 10px; border-top: 1px solid #333; color: var(--text-dim); }

        /* ÁREA CENTRALIZADA */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Tira as letras do topo e coloca no meio */
            padding: 40px;
        }

        .word-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            width: 100%;
            max-width: 900px;
            margin-bottom: 50px;
            min-height: 100px;
        }

        .letter-box {
            width: 65px;
            height: 80px;
            background: var(--card-bg);
            border: 2px solid #444;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            user-select: none;
        }

        /* Efeito Hover: Sobe e fica vermelho */
        .letter-box:hover {
            border-color: var(--error);
            color: var(--error);
            background: rgba(207, 102, 121, 0.1);
            transform: translateY(-10px);
        }

        .input-controls { display: flex; gap: 15px; }

        input {
            background: #000;
            border: 2px solid #444;
            color: white;
            padding: 15px;
            border-radius: 10px;
            width: 80px;
            text-align: center;
            font-size: 1.5rem;
            outline: none;
        }
        input:focus { border-color: var(--accent); }

        button#validate-btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 0 30px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        .feedback { margin-top: 25px; font-weight: bold; font-size: 1.2rem; height: 30px; }
        .success-flash { box-shadow: inset 0 0 60px rgba(3, 218, 198, 0.3); }
        .error-flash { box-shadow: inset 0 0 60px rgba(207, 102, 121, 0.3); }
    </style>
</head>
<body>

    <div class="app-container">
        <aside class="sidebar">
            <h2>LexiMagic</h2>
            <div class="rules-section">
                <h3>Regras Ativas</h3>
                <div id="rule-vowel" class="rule-card"><strong>Vogal:</strong> Próxima letra avança no alfabeto)</div>
                <div id="rule-consonant" class="rule-card"><strong>Consoante:</strong> Espelha anterior</div>
                <div id="rule-repeat" class="rule-card"><strong>Repetição:</strong> Inverte bloco</div>
                <div id="rule-random" class="rule-card"><strong>Expansão:</strong> Letras aleatórias</div>
                <div id="rule-pruning" class="rule-card"><strong>Poda (3x):</strong> 3 consoantes iguais apagam antiga</div>
            </div>

            <div class="history-section">
                <h3>Histórico</h3>
                <div id="input-history" class="history-list"></div>
                <button id="clear-history">Limpar</button>
            </div>

            <div class="status-info">Tamanho: <span id="char-count">0</span> / 52</div>
        </aside>

        <main class="game-area">
            <div id="word-grid" class="word-grid"></div>
            <div class="input-controls">
                <input type="text" id="char-input" maxlength="1" autofocus>
                <button id="validate-btn">Validar</button>
            </div>
            <div id="feedback-message" class="feedback"></div>
        </main>
    </div>

    <audio id="success-sound" src="https://actions.google.com/sounds/v1/cartoon/clap_and_cheer_one_person.ogg"></audio>

    <script>
        /* --- LÓGICA (JS) --- */
        const wordGrid = document.getElementById('word-grid');
        const charInput = document.getElementById('char-input');
        const validateBtn = document.getElementById('validate-btn');
        const charCountLabel = document.getElementById('char-count');
        const feedback = document.getElementById('feedback-message');
        const historyList = document.getElementById('input-history');
        const successSound = document.getElementById('success-sound');

        let currentWord = [];
        let lastChar = '';
        let cCombo = 0; // Contador para a regra de 3x

        const isVowel = (c) => 'AEIOUaeiou'.includes(c);

        function shiftAlphabet(char) {
            const code = char.charCodeAt(0);
            const start = char === char.toUpperCase() ? 65 : 97;
            const limit = char === char.toUpperCase() ? 90 : 122;
            return String.fromCharCode(code + 1 > limit ? start : code + 1);
        }

        function mirrorAlphabet(char) {
            const alphabet = "abcdefghijklmnopqrstuvwxyz";
            const isUpper = char === char.toUpperCase();
            const idx = alphabet.indexOf(char.toLowerCase());
            if (idx === -1) return char;
            const mirrored = alphabet[25 - idx];
            return isUpper ? mirrored.toUpperCase() : mirrored;
        }

        function highlight(id) {
            const el = document.getElementById(id);
            if (el) { el.classList.add('rule-active'); setTimeout(() => el.classList.remove('rule-active'), 800); }
        }

        function render() {
            wordGrid.innerHTML = '';
            currentWord.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = 'letter-box';
                div.innerText = c;
                div.onclick = () => { currentWord.splice(i, 1); render(); };
                wordGrid.appendChild(div);
            });
            charCountLabel.innerText = currentWord.length;
        }

        function addChar(char) {
            if (!/^[a-zA-Z]$/.test(char) || currentWord.length >= 52) return;

            // Histórico
            historyList.innerHTML += char.toUpperCase() + ' ';
            historyList.scrollTop = historyList.scrollHeight;

            // Poda (3x)
            if (!isVowel(char)) {
                if (char.toLowerCase() === lastChar.toLowerCase()) cCombo++;
                else cCombo = 1;

                if (cCombo === 3) {
                    highlight('rule-pruning');
                    currentWord.shift();
                    cCombo = 0;
                }
            } else { cCombo = 0; }
            lastChar = char;

            // Espelhamento
            if (!isVowel(char) && currentWord.length > 0) {
                highlight('rule-consonant');
                currentWord[currentWord.length - 1] = mirrorAlphabet(currentWord[currentWord.length - 1]);
            }

            // Inversão
            const firstIdx = currentWord.indexOf(char.toUpperCase());
            currentWord.push(char.toUpperCase());
            if (firstIdx !== -1 && firstIdx < currentWord.length - 1) {
                highlight('rule-repeat');
                const start = firstIdx + 1;
                const end = currentWord.length - 1;
                const mid = currentWord.slice(start, end).reverse();
                currentWord.splice(start, mid.length, ...mid);
            }

            // Vogal Shift
            if (currentWord.length > 1 && isVowel(currentWord[currentWord.length - 2])) {
                highlight('rule-vowel');
                currentWord[currentWord.length - 1] = shiftAlphabet(currentWord[currentWord.length - 1]);
            }

            render();
        }

        async function validate() {
            const word = currentWord.join('').toLowerCase();
            if (word.length < 2) return;
            feedback.innerText = "Consultando...";
            try {
                const res = await fetch(`https://api.dicionario-aberto.net/word/${word}`);
                const data = await res.json();
                if (data.length > 0) {
                    feedback.innerText = "✅ Palavra Válida!";
                    feedback.style.color = "var(--success)";
                    document.body.classList.add('success-flash');
                    successSound.play();
                } else {
                    feedback.innerText = "❌ Inexistente";
                    feedback.style.color = "var(--error)";
                    document.body.classList.add('error-flash');
                }
            } catch { feedback.innerText = "Erro na API"; }
            setTimeout(() => { 
                document.body.classList.remove('success-flash', 'error-flash'); 
                feedback.innerText = ""; 
            }, 2000);
        }

        charInput.addEventListener('input', (e) => { addChar(e.target.value); e.target.value = ''; });
        validateBtn.addEventListener('click', validate);
        document.getElementById('clear-history').onclick = () => historyList.innerHTML = '';
        document.body.onclick = (e) => { if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') charInput.focus(); };
    </script>
</body>
</html>